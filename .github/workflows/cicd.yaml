name: Deploy to EC2

on:
  push:
    branches: [ main ]

env:
  AWS_REGION: us-east-1 # Change this to your AWS region

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Install SSH key
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
    
    - name: Add EC2 to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to EC2
      run: |
        # Create deployment script
        echo '#!/bin/bash
        cd /var/www/html
        
        # Pull latest changes
        sudo git pull origin main
        
        # Install/update dependencies
        sudo composer install --no-dev --optimize-autoloader
        
        # Set correct permissions
        sudo chown -R www-data:www-data .
        sudo chmod -R 755 .
        
        # Copy environment file if it doesn't exist
        if [ ! -f "config/.env" ]; then
          sudo cp .env.example config/.env
        fi
        
        # Restart services
        sudo systemctl restart php8.1-fpm
        sudo systemctl restart nginx
        ' > deploy.sh
        
        chmod +x deploy.sh
        
        # Copy deployment script and execute on EC2
        scp -o StrictHostKeyChecking=no deploy.sh ubuntu@${{ secrets.EC2_HOST }}:/tmp/
        ssh ubuntu@${{ secrets.EC2_HOST }} "sudo bash /tmp/deploy.sh"